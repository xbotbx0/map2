<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุชุจุน ุงููููุน ุงูุญู</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="stylesheet" href="main.css"/></head>
<body>


    <div id="map"></div>
    <div id="speed" onclick="location.reload();" >ุงูุณุฑุนุฉ: 0 ูู/ุณ</div>


    <nav class="nav-bar">
        <div class="nav-buttons">
            <button class="nav-button" title="ุงููุงุฆูุฉ">
                <i class="fas fa-bars"></i>
            </button>
            <button class="nav-button" title="ุชุนุฏูู">
                <i class="fas fa-edit"></i>
            </button>
            
            <button class="nav-button" id="centerButton"  title="ุชูุณูุท ุงููููุน">
                <i class="fas fa-crosshairs"></i>
            </button>

            </button>
           <button class="nav-button logout-btn" title="ุชุณุฌูู ุงูุฎุฑูุฌ">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
    </nav>












    

    <!-- Firebase ู Leaflet scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, update, onDisconnect } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // ุฏุงุฎู script type="module"
import { get, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // ุชูููู Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB9ZqQCZG9g3qclDz-kLHrNQparJT_iBXc",
            authDomain: "mypro-d8761.firebaseapp.com",
            databaseURL: "https://mypro-d8761-default-rtdb.firebaseio.com",
            projectId: "mypro-d8761",
            storageBucket: "mypro-d8761.appspot.com",
            messagingSenderId: "439741574644",
            appId: "1:439741574644:web:50b693546c7d32a5579da1"
        };

        // ุชููุฆุฉ ุงูุชุทุจูู
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // ุฅุฏุงุฑุฉ ุญุงูุฉ ุงููุณุชุฎุฏู
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู:", user.uid);
                const userRef = ref(db, 'users/' + user.uid);
                
                // ุฅุนุฏุงุฏ ุฎุงุตูุฉ ุงูุญุฐู ุนูุฏ ูุทุน ุงูุงุชุตุงู
                //onDisconnect(userRef).remove();

                // ุชุนููู ุฏุงูุฉ ุงูุญูุธ ูููุตูู ุงูุนุงู
                window.saveToDB = (lat, lng, speed) => {
                    console.log("ุญูุธ ุงูุจูุงูุงุช ูููุณุชุฎุฏู:", user.uid, { lat, lng, speed });

                    update(userRef, {
                        latitude: lat,
                        longitude: lng,
                        speed: speed,
                        timestamp: Date.now()
                    }).then(() => {
                        console.log("ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ");
                    }).catch((error) => {
                        console.error('ุฎุทุฃ ูู ุญูุธ ุงูุจูุงูุงุช:', error);
                    });


                    // ุฅุถุงูุฉ ูุณุชูุน ูุชุญุฏูุซุงุช ุจูุงูุงุช ุงููุณุชุฎุฏู
onValue(userRef, (snapshot) => {
    const userData = snapshot.val();
    window.userInfo = {
        username: userData?.username || 'ุบูุฑ ูุนุฑูู',
        email: user.email,
        speed: userData?.speed || 0,
        coords: userData ? [userData.latitude, userData.longitude] : [0, 0]
    };
});


                };
            } else {
                window.location.href = "login.html";
            }
        });

        // ุชุณุฌูู ุงูุฎุฑูุฌ
        document.querySelector('.logout-btn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error("ุฎุทุฃ ูู ุชุณุฌูู ุงูุฎุฑูุฌ:", error);
                alert("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุญุงููุฉ ุชุณุฌูู ุงูุฎุฑูุฌ");
            }
        });

    </script>








<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>

    // ุชุนุฑูู ุงูุฑูุฒ ุงููุงุจุถ
const redPulseIcon = L.divIcon({
    className: 'pulsing-marker',
    iconSize: [20, 20],
    iconAnchor: [10, 10]
});


    // Initialize map with full screen
    let map = L.map('map', {
        zoomControl: false
    }).setView([24.774265, 46.738586], 13);

    let marker = null;
    let path = [];
    let polyline = null;
    let isFirstUpdate = true;
    let currentPosition = null; // ุฅุถุงูุฉ ูุชุบูุฑ ูุชุชุจุน ุงููููุน ุงูุญุงูู

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Speed element
    const speedElement = document.getElementById('speed');
    const centerButton = document.getElementById('centerButton'); // ุฅุถุงูุฉ ูุฑุฌุน ูุฒุฑ ุงูุชูุณูุท




    function updateLocation(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    const speed = position.coords.speed * 3.6;

    currentPosition = { lat, lng };

    if (!marker) {
        marker = L.marker([lat, lng], { icon: redPulseIcon })
            .bindPopup(createPopupContent(speed, lat, lng))
            .addTo(map);
    } else {
        marker.setLatLng([lat, lng])
            .setPopupContent(createPopupContent(speed, lat, lng));
    }



path.push([lat, lng]);

if (polyline) map.removeLayer(polyline);
polyline = L.polyline(path, {color: 'red'}).addTo(map);

speedElement.textContent = `ุงูุณุฑุนุฉ: ${speed.toFixed(1)} ูู/ุณ`;

if (isFirstUpdate) {
    map.setView([lat, lng], 13);
    isFirstUpdate = false;
}


            // ุญูุธ ุงูุจูุงูุงุช ูู Firebase
            if (typeof window.saveToDB === 'function') {
                window.saveToDB(lat, lng, speed.toFixed(1));
            }
        }



        function handleError(error) {
        console.error('Geolocation error:', error);
        speedElement.textContent = 'ุฎุทุฃ ูู ุชุญุฏูุฏ ุงููููุน ุงููุฑ ููุชุญุฏูุซ ๐!';
    }

    if (navigator.geolocation) {
        navigator.geolocation.watchPosition(updateLocation, handleError, {
            enableHighAccuracy: true,
            maximumAge: 30000,
            timeout: 27000
        });
    }

    window.addEventListener('resize', () => {
        map.invalidateSize();
    });

    // Add zoom control with custom position
    L.control.zoom({
        position: 'bottomright'
    }).addTo(map);


// ุฏุงูุฉ ุงูุชูุณูุท ุงููุนุฏูุฉ
function focusOnLocation() {
    if (currentPosition) {
        map.setView([currentPosition.lat, currentPosition.lng], 13);
        marker.openPopup();
        setTimeout(() => marker.closePopup(), 3000);
    } else {
        alert("ูุง ููุฌุฏ ูููุน ูุชุงุญ ุญุงูููุง!");
    }
}

// ุฅุถุงูุฉ ุญุฏุซ ุงูููุฑ ููุฒุฑ
document.getElementById('centerButton').addEventListener('click', focusOnLocation);

        // ... (ุจููุฉ ุงูุฏูุงู ูุงูุฃุญุฏุงุซ ููุง ูู) ...


        function createPopupContent(speed, lat, lng) {
    return `
        <div dir="rtl" style="text-align: right;">
            <h4 style="margin: 5px 0;">ูุนูููุงุช ุงููุณุชุฎุฏู</h4>
            <hr style="margin: 5px 0;">
            <b>ุงูุงุณู:</b> ${window.userInfo?.username || 'ุบูุฑ ูุนุฑูู'}<br>
            <b>ุงูุฅูููู:</b> ${window.userInfo?.email || 'ุบูุฑ ูุนุฑูู'}<br>
            <b>ุงูุณุฑุนุฉ:</b> ${speed.toFixed(1)} ูู/ุณ<br>
            <b>ุงูุฅุญุฏุงุซูุงุช:</b><br>
            ${lat.toFixed(6)}, ${lng.toFixed(6)}
        </div>
    `;
}
    </script>










</body>
</html>


